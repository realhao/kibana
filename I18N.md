# 基于Kibana 6.1.3的翻译说明

### 阶段一

#### TODO...

1. 性能影响如何评估，影响如何？
  - 为什么`kibana/src/ui/public/share/views/share.html`里的`i18nT`在分享面板打开后，鼠标hover菜单会一直被调用？
  - 为什么模板里的translate会被调用3次？
2. 翻译内容的变量替换，变量也需要翻译的时候，命名空间传递的写法是否可以简便些？
  - 需要在翻译的时候默认查找同命名空间下的内容，如果没有再往上找？

#### 翻译了哪些地方

##### 时间/数字/货币...
1. 现阶段使用[pluralization](https://angular-translate.github.io/docs/#/guide/14_pluralization)来处理这类问题。
2. 解决`Localisation function not found for locale default`报错问题。

###### 数字

###### 时间

###### 货币

##### UI

###### 翻译文件抽取
```javascript
// To link to another translation id, all you have to do is to prefix its contents with an @: sign followed by the full name of the translation id including the namespace you want to link to.
{
  "EDIT": "Edit",
  "DISCOVER": {
    "EDIT": "@:EDIT",
  }
}

```

###### 服务端渲染模板
jade动态模板，例如`#{i18n('UI-WELCOME_MESSAGE')}`

###### Angular内翻译：
```javascript
{
  "hello": "hello, {{world}}!",
  "world": "abc"
}
// output is {{'hello' | translate:{world:'123'}}}
{{'hello' | translate:{world:'123'}}}
// output is hello 123!
{{ 'hello' | translate:{world:'123'} }}
// translate variable replacement, output is hello abc!
{{ 'hello' | translate:{world: ('world' | translate)} }}
// https://github.com/angular-translate/angular-translate/issues/1667
// https://plnkr.co/edit/leGbBcoxsCq7GubOkfEu?p=preview

// in directive,controller,services...
$translate.instant('abc')

// in template
{'KKEYNAME' | translate}

// in template use ng-options
<select
  ng-model="relative.from.unit"
  ng-options="opt.value as opt.text | translate for opt in relativeOptions"
  ng-change="formatRelative({key:'from'})"
  ng-class="{ 'kuiSelect-isInvalid': checkRelative() }"
  class="kuiSelect fullWidth"></select>

// in template use ng-pluralize
<ng-pluralize
  count="hits"
  when="{'1':'{{&quot;HIT&quot; | translate}}', 'other':'{{&quot;HITS&quot; | translate}}'}"></ng-pluralize>

// in template use translate pluralize
<ng-pluralize count="warnings.length" when="{'1':'warning', 'other':'warnings'}"></ng-pluralize>
"WARNINGS-PLURAL": "{num, plural, =0{warning} other{warnings}}",
"WARNINGS-PLURAL": "{num, plural, =0{报警} other{报警}}",
{{ 'DISCOVER.WARNINGS-PLURAL' | translate:{num:warnings.length}:"messageformat" }}

// in template use ng-bind
<a class="kuiLink"
  ng-click="setQuick({from: option.from, to: option.to})"
  ng-bind="::option.display | translate"
  kbn-accessible-click></a>
<button
  ng-bind="::field.display ? 'DISCOVER.REMOVE' : 'DISCOVER.ADD' | translate"
  class="discover-sidebar-item-action kuiButton kuiButton--small"
  data-test-subj="fieldToggle-{{::field.name}}"></button>

// varable replacement
"AUTOREFRESHTIP": "Data will refresh every {{refreshInterval}}"
$scope.translateFn = $translate.instant;
<span ng-show="timefilter.refreshInterval.value > 0"
      aria-label="{{ 'TIMEPICKER.AUTOREFRESHTIP' | translate:{refreshInterval:translateFn(timefilter.refreshInterval.display)} }}">

// translate html content
<span
  class="kbn-timepicker-action-item kbn-timepicker-error"
  ng-show="checkRelative()"
  ng-bind-html="'TIMEPICKER.FROMBEFORETONOTE' | translate | trusted"></span>
```

###### React Componet里翻译
因为目前看到的都是Angular通过ngReact调用组件，所以组件的翻译，主要涉及：
1. 直接被Angular调用的组件，上下文里用Angular场景的翻译
2. react子组件的翻译，把Angular的翻译方法通过属性绑定给到react，供子组件调用时翻译。
```javascript
// angular
// https://docs.angularjs.org/guide/scope#scope-hierarchies
uiModules
  .get('kibana')
  .run(function ($rootScope, $filter, $translate) {
    // 1. wrap custom translate function, can be used for react component
    // 2. use for translate content and with namespace
    //    eg translateId is 'NS.HELLO' can be
    //    a. t('hello', 'ns')
    //    b. t('hello', { replaceVar: 'foo', ns: 'ns' })
    //    c. t('ns.hello', '')
    // 3. if translated text equal to translateId, return input content 'hello'
    $rootScope.t = chrome.getReactTranslateFun($translate.instant);
  });
// angular tmplate
<react-component-app t="t" i18nT="i18nT">
// react
{t('KEY')}
{i18nT('Title')}
// react parent component
<Home
  addBasePath={addBasePath}
  directories={directories}
  t={t}
  i18nT={i18nT}
/>

```

#### 还需要注意的部分

1. 默认语言设置为**en**，可以保证翻译文件未覆盖到的部分都是英文状态。
2. 在未找到key对应的翻译值时，会返回key
	- 2.1 动态数据的翻译可直接把内容作为key，只要其中不含`.`就可以，因为`.`会被当做命名空间的分隔符使用。在*任何ui还未mixn*的情况下，如服务端的某些配置需要翻译，同样适用。
	- 2.2 不要使用未定义的key，至少保证有一种语言会被命中，最好是英文。
3. 某些单测用例是关联内容文字的，可能会失败:confused:

> 例如：
> `"Discover": "日志检索"`
> `"Hello Foo!": "你好，Foo!"`


#### 参考
1. [kibana官方issue的记录](https://github.com/elastic/kibana/issues/6515)
2. [源码里关于翻译的说明](/docs/development/plugin/development-internationalization.asciidoc)
3. [angular i18n and i10n](https://docs.angularjs.org/guide/i18n)
4. [angular-translate docs](https://angular-translate.github.io/docs)
5. [icu project](http://userguide.icu-project.org/i18n)
6. [ApacheCN Kibana 5.2文档](http://cwiki.apachecn.org/pages/viewpage.action?pageId=8159377)
7. [ngReact](https://github.com/ngReact/ngReact)
