# 基于Kibana 6.1.3的翻译说明

### 阶段一

#### 环境准备

官方[开发环境准备](CONTRIBUTING.md#setting-up-your-development-environment)

```bash
# 对node的依赖
# 使用nvm首次安装要求版本的node
nvm install (cat .node-version)
# 已经安装过
cat .node-version
nvm list
nvm use v6.12.2
# 查看版本，6.12.2
node -v


# 开发配置 config/kibana.dev.yml， 避免把内部地址暴露到github上

# 可选，如果国内安装缓慢，可使用淘宝镜像
# npm config set registry https://registry.npm.taobao.org
# export CHROMEDRIVER_CDNURL=http://npm.taobao.org/mirrors/chromedriver

# 安装
npm install
# 安装后会报npm WARN grunt-angular-translate@0.3.0 requires a peer of grunt@~0.4.0 but none was installed.
# 原因是：
# 1. kibana devDependencies grunt-angular-translate@0.3.0
# 2. grunt-angular-translate peerDependencies grunt@~0.4.0，兼容0.4.x最新版本
# 3. kibana devDependencies grunt@1.0.1
# 关于peerDependencies
# https://docs.npmjs.com/files/package.json#peerdependencies
# http://www1.qdfuns.com/blog-5424929-5406624.html
# 目前开发中没有影响，暂时忽略
# 完全确认这个报警不会有影响，需要排查grunt-angular-translate@0.3.0 配合grunt@0.4.5的接口中，grunt@1.0.1里删除或者修改了的

# 启动
npm start
# 或者不想要随机生成的字符串
node ./bin/../src/cli --dev --no-base-path

# 编译，Kibana编译默认会扫描所有使用到的翻译KEY，如果语言文件里没有这个KEY，会报警并结束编译。
# 目前可以用这个命令忽略报警，后续需要优化下针对这个检查的配置。
grunt build --force

```

#### 翻译了哪些地方

##### 时间/数字/货币...
1. 现阶段使用[pluralization](https://angular-translate.github.io/docs/#/guide/14_pluralization)来处理这类问题。
2. 解决`Localisation function not found for locale default`报错问题。

###### 数字

###### 时间

###### 货币

##### UI

###### 翻译文件抽取
```javascript
// To link to another translation id, all you have to do is to prefix its contents with 
// an @: sign followed by the full name of the translation id including the namespace you want to link to.
{
  "EDIT": "Edit",
  "DISCOVER": {
    "EDIT": "@:EDIT",
  }
}

```

###### 服务端渲染模板
函数定义在[这里](src/ui/index.js)，`i18n: key => _.get(translations, key, '')`
在jade动态模板调用的场景很少，多见Angular启动前，例：`#{i18n('UI-WELCOME_MESSAGE')}`

###### Angular内翻译：
```javascript
// three way in angular template
//   1. translate filter (angular-translate default translate filter, [source code](https://github.com/angular-translate/angular-translate/blob/2.13.1/src/filter/translate.js))
//   2. i18nT filter (wrapped translate filter up in [this](src/ui/public/filters/i18n_t.js))
//   3. custom function
// translation/__language__.json
{
  "hello": "hello, {{world}}!",
  "world": "abc"
}
// ✔ used in angular templte with right way
// output: hello 123!
{{ 'hello' | translate:{world:'123'} }}
// space is mondatory between a close brace and a double close brace
// ✘ this is a wrong way, output: {{'hello' | translate:{world:'123'}}}
{{'hello' | translate:{world:'123'}}}
// translate variable replacement, output is hello abc!
// https://github.com/angular-translate/angular-translate/issues/1667
// https://plnkr.co/edit/leGbBcoxsCq7GubOkfEu?p=preview
{{ 'hello' | translate:{world: ('world' | translate)} }}

// how to use i18nT with translate-namespace directive
 <kbn-management-landing translate-namespace="management">
    <div class="page-row">
      <div class="page-row-text">{{::'Version'|i18nT:translateNamespace}}: {{::kbnVersion}}</div>
    </div>
    ...
</kbn-management-landing>

// in template use ng-options
<select
  ng-model="relative.from.unit"
  ng-options="opt.value as opt.text | translate for opt in relativeOptions"
  ng-change="formatRelative({key:'from'})"
  ng-class="{ 'kuiSelect-isInvalid': checkRelative() }"
  class="kuiSelect fullWidth"></select>

// in template use translate pluralize
// before translated...
<ng-pluralize count="warnings.length" when="{'1':'warning', 'other':'warnings'}"></ng-pluralize>
// after translated...
// in translation/__language__.json
{
  "WARNINGS-PLURAL": "{num, plural, =0{warning} other{warnings}}",
  "WARNINGS-PLURAL": "{num, plural, =0{报警} other{报警}}"
}
// used in template 
{{ 'DISCOVER.WARNINGS-PLURAL' | translate:{num:warnings.length}:"messageformat" }}

// ✘ it's another way, deprecated
<ng-pluralize
  count="hits"
  when="{'1':'{{&quot;HIT&quot; | translate}}', 'other':'{{&quot;HITS&quot; | translate}}'}"></ng-pluralize>

// in template use ng-bind
<button
  ng-bind="::field.display ? 'DISCOVER.REMOVE' : 'DISCOVER.ADD' | translate"
  class="discover-sidebar-item-action kuiButton kuiButton--small"
  data-test-subj="fieldToggle-{{::field.name}}"></button>

// translate html content
<span
  class="kbn-timepicker-action-item kbn-timepicker-error"
  ng-show="checkRelative()"
  ng-bind-html="'TIMEPICKER.FROMBEFORETONOTE' | translate | trusted"></span>

// in directive,controller,services... etc javascript
$translate.instant('abc')
```

###### React Componet里翻译
因为目前看到的都是Angular通过ngReact调用组件，所以组件的翻译，主要涉及：
1. 直接被Angular调用的组件，上下文里用Angular场景的翻译
2. react子组件的翻译，把Angular的翻译方法通过属性绑定给到react，供子组件调用时翻译。
```javascript
// angular
// https://docs.angularjs.org/guide/scope#scope-hierarchies
uiModules
  .get('kibana')
  .run(function ($rootScope, $filter, $translate) {
    // 1. wrap custom translate function, can be used in react component
    // 2. use for translate content with namespace
    //    eg translateId is 'NS.HELLO' can be
    //    a. t('hello', 'ns')
    //    b. t('hello', { replaceVar: 'foo', ns: 'ns' })
    // 3. if translated text equal to translateId, return input content 'hello'
    $rootScope.t = chrome.getReactTranslateFun($translate.instant);
  });
// in angular tmplate
<react-component-app t="t">
// in react template
{t('KEY')}

// react parent component
<Home
  addBasePath={addBasePath}
  directories={directories}
  t={t}
/>
// react child child component
{this.props.t('EXITFULLSCREEN')}
```

#### 还需要注意的部分

1. 默认语言设置为**en**，可以保证翻译文件未覆盖到的部分都是英文状态。
2. 在未找到key对应的翻译值时，会返回key
	 - 2.1 动态数据的翻译可直接把内容作为key，只要其中不含`.`就可以，因为`.`会被当做命名空间的分隔符使用。在*任何ui还未mixn*的情况下，如服务端的某些配置需要翻译，同样适用。
	 - 2.2 不要使用未定义的key，至少保证有一种语言会被命中，最好是英文。
3. 某些单测用例是关联内容文字的，可能会失败:confused:

> 例如：
> `"Discover": "日志检索"`
> `"Hello Foo!": "你好，Foo!"`

#### TODO...

1. grunt build 的翻译检查如何调整？
2. 性能影响如何评估，影响如何？
   - 为什么`kibana/src/ui/public/share/views/share.html`里的`i18nT`在分享面板打开后，鼠标hover菜单会一直被调用？
   - 为什么模板里的translate会被调用3次？
3. 翻译内容的变量替换，变量也需要翻译的时候，命名空间传递的写法是否可以简便些？
   - 需要在翻译的时候默认查找同命名空间下的内容，如果没有再往上找？


#### 参考
1. [kibana官方issue的记录](https://github.com/elastic/kibana/issues/6515)
2. [源码里关于翻译的说明](/docs/development/plugin/development-internationalization.asciidoc)
3. [angular i18n and i10n](https://docs.angularjs.org/guide/i18n)
4. [angular-translate docs](https://angular-translate.github.io/docs)
5. [icu project](http://userguide.icu-project.org/i18n)
6. [ApacheCN Kibana 5.2文档](http://cwiki.apachecn.org/pages/viewpage.action?pageId=8159377)
7. [ngReact](https://github.com/ngReact/ngReact)
